<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ask Marvin</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f0f2f5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 48px 16px 80px;
      color: #1a1a2e;
    }

    /* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
    #topbar {
      width: 100%;
      max-width: 700px;
      display: flex;
      justify-content: flex-end;
      margin-bottom: 8px;
    }
    #settings-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 6px;
      border-radius: 8px;
      color: #666;
      line-height: 1;
      transition: background 0.15s, color 0.15s;
    }
    #settings-btn:hover { background: #e4e6ea; color: #333; }
    #settings-btn svg { display: block; }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      text-align: center;
      margin-bottom: 36px;
    }
    header .logo { font-size: 2.4rem; margin-bottom: 8px; }
    header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #1a1a2e;
      letter-spacing: -0.5px;
    }
    header p { margin-top: 6px; color: #666; font-size: 0.95rem; }

    /* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
    .card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.06);
      padding: 28px;
      width: 100%;
      max-width: 700px;
    }

    /* ‚îÄ‚îÄ Search form ‚îÄ‚îÄ */
    #search-form { display: flex; gap: 10px; }
    #query-input {
      flex: 1;
      border: 1.5px solid #d8dce5;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 1rem;
      font-family: inherit;
      color: #1a1a2e;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      background: #fafbfc;
    }
    #query-input:focus {
      border-color: #6c47ff;
      box-shadow: 0 0 0 3px rgba(108,71,255,0.12);
      background: #fff;
    }
    #query-input::placeholder { color: #aaa; }

    #ask-btn {
      background: #6c47ff;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 12px 22px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.15s, transform 0.1s;
      font-family: inherit;
    }
    #ask-btn:hover:not(:disabled) { background: #5a38e0; }
    #ask-btn:active:not(:disabled) { transform: scale(0.97); }
    #ask-btn:disabled { background: #b3a0f5; cursor: not-allowed; }

    /* ‚îÄ‚îÄ Status ‚îÄ‚îÄ */
    #status-area { margin-top: 24px; display: none; }
    #thinking-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 7px 0;
      font-size: 0.9rem;
      color: #555;
    }

    .spinner {
      width: 18px; height: 18px;
      border: 2.5px solid #e0d9ff;
      border-top-color: #6c47ff;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */
    #error-area {
      display: none;
      margin-top: 20px;
      background: #fff8f0;
      border: 1.5px solid #f5c578;
      border-radius: 10px;
      padding: 14px 16px;
      font-size: 0.9rem;
      color: #7a4500;
    }
    #error-area strong { display: block; margin-bottom: 4px; }

    /* ‚îÄ‚îÄ Answer ‚îÄ‚îÄ */
    #answer-area { display: none; margin-top: 28px; animation: fadeIn 0.35s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; } }

    .answer-label {
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #6c47ff;
      margin-bottom: 10px;
    }
    #answer-text {
      background: #fafafa;
      border-left: 3px solid #6c47ff;
      border-radius: 0 10px 10px 0;
      padding: 16px 18px;
      font-size: 1rem;
      line-height: 1.7;
      color: #1a1a2e;
      white-space: pre-wrap;
      word-break: break-word;
    }
    #answer-meta {
      margin-top: 12px;
      font-size: 0.78rem;
      color: #999;
      display: flex;
      flex-wrap: wrap;
      gap: 6px 16px;
    }

    /* ‚îÄ‚îÄ Settings modal ‚îÄ‚îÄ */
    #modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    #modal-overlay.open { display: flex; }

    #settings-modal {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.18);
      padding: 32px;
      width: min(480px, calc(100vw - 32px));
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    #settings-modal h2 { font-size: 1.15rem; font-weight: 700; margin-bottom: 20px; }
    #modal-close {
      position: absolute;
      top: 16px; right: 16px;
      background: none; border: none; cursor: pointer;
      color: #888; font-size: 1.4rem; line-height: 1;
      padding: 4px 8px; border-radius: 6px;
    }
    #modal-close:hover { background: #f0f0f0; color: #333; }

    .field { margin-bottom: 18px; }
    .field label {
      display: block;
      font-size: 0.82rem;
      font-weight: 600;
      color: #444;
      margin-bottom: 6px;
    }
    .field input {
      width: 100%;
      border: 1.5px solid #d8dce5;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 0.95rem;
      font-family: inherit;
      color: #1a1a2e;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .field input:focus {
      border-color: #6c47ff;
      box-shadow: 0 0 0 3px rgba(108,71,255,0.12);
    }
    .field .hint { margin-top: 4px; font-size: 0.75rem; color: #999; }
    .field .hint a { color: #6c47ff; text-decoration: none; }
    .field .hint a:hover { text-decoration: underline; }

    #save-settings-btn {
      width: 100%;
      background: #6c47ff;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 11px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.15s;
      margin-top: 4px;
    }
    #save-settings-btn:hover { background: #5a38e0; }

    .setup-notice {
      background: #f0edff;
      border-radius: 10px;
      padding: 14px 16px;
      font-size: 0.85rem;
      color: #4a2ea0;
      margin-bottom: 24px;
      line-height: 1.5;
    }
    .setup-notice strong { display: block; margin-bottom: 2px; }

    .section-divider {
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #aaa;
      margin: 8px 0 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f0f0f0;
    }
  </style>
</head>
<body>

  <div id="topbar">
    <button id="settings-btn" title="Settings" aria-label="Settings">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
      </svg>
    </button>
  </div>

  <header>
    <div class="logo">üîç</div>
    <h1>Ask Marvin</h1>
    <p>Natural language search across your Amazing Marvin notes &amp; projects</p>
  </header>

  <div class="card">
    <form id="search-form" autocomplete="off">
      <input
        id="query-input"
        type="text"
        placeholder="e.g. when is BNY Dublin go live?"
        required
        autocomplete="off"
        spellcheck="true"
      />
      <button id="ask-btn" type="submit">Ask</button>
    </form>

    <div id="status-area">
      <div id="thinking-indicator">
        <div class="spinner"></div>
        <span>Thinking‚Ä¶</span>
      </div>
    </div>

    <div id="error-area">
      <strong id="error-title">Something went wrong</strong>
      <span id="error-detail"></span>
    </div>

    <div id="answer-area">
      <div class="answer-label">Answer</div>
      <div id="answer-text"></div>
      <div id="answer-meta">
        <span id="meta-query"></span>
        <span id="meta-projects"></span>
        <span id="meta-cost"></span>
      </div>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="settings-title">
    <div id="settings-modal">
      <button id="modal-close" aria-label="Close">&times;</button>
      <h2 id="settings-title">Settings</h2>

      <div class="setup-notice" id="first-run-notice" style="display:none">
        <strong>One-time setup</strong>
        Enter your API credentials below. They're saved in your browser only.
      </div>

      <div class="section-divider">Amazing Marvin</div>

      <div class="field">
        <label for="s-marvin-token">API Token</label>
        <input id="s-marvin-token" type="password" placeholder="Your Marvin API token" />
        <div class="hint">Found in Amazing Marvin ‚Üí Settings ‚Üí API ‚Üí API Token</div>
      </div>
      <div class="field">
        <label for="s-marvin-full-token">Full Access Token</label>
        <input id="s-marvin-full-token" type="password" placeholder="Your Marvin Full Access Token" />
        <div class="hint">Found in Amazing Marvin ‚Üí Settings ‚Üí API ‚Üí Full Access Token (needed for reading notes)</div>
      </div>

      <div class="section-divider">OpenAI</div>

      <div class="field">
        <label for="s-openai-key">API Key</label>
        <input id="s-openai-key" type="password" placeholder="sk-‚Ä¶" />
        <div class="hint">
          From <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener">platform.openai.com/api-keys ‚Üó</a>
        </div>
      </div>

      <button id="save-settings-btn">Save</button>
    </div>
  </div>

  <script>
    // ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const LS = {
      get marvinToken()     { return localStorage.getItem('marvin_api_token')          || ''; },
      get marvinFullToken() { return localStorage.getItem('marvin_full_access_token')  || ''; },
      get openaiKey()       { return localStorage.getItem('marvin_openai_key')         || ''; },
      save(marvinToken, marvinFullToken, openaiKey) {
        localStorage.setItem('marvin_api_token',         marvinToken);
        localStorage.setItem('marvin_full_access_token', marvinFullToken);
        localStorage.setItem('marvin_openai_key',        openaiKey);
      },
      get isConfigured() { return !!(this.marvinToken && this.marvinFullToken && this.openaiKey); }
    };

    const MARVIN_BASE = 'https://serv.amazingmarvin.com/api';
    const OPENAI_URL  = 'https://api.openai.com/v1/chat/completions';
    const MODEL       = 'gpt-4.1-nano';

    // ‚îÄ‚îÄ OpenAI prompts (identical to search_marvin.py) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const PROMPT_IDENTIFY_SYSTEM = `You are a search assistant for a personal task manager. Given a user query and a list of projects, identify which projects are most likely to contain the answer. Return ONLY a JSON array of the relevant project IDs (strings), ordered by relevance, maximum 10 items. When in doubt, include the project ‚Äî it is better to search too many than too few. If no project seems relevant, return an empty array []. Return valid JSON only ‚Äî no explanation, no markdown.`;

    const PROMPT_ANSWER_SYSTEM = `You are a personal assistant with access to a user's task manager data. Answer the user's question directly and concisely using ONLY the information provided below. If the answer is clearly present, state it plainly. If the information is not found in the provided data, say so explicitly ‚Äî do not guess or hallucinate. Format your answer for readability.`;

    // ‚îÄ‚îÄ Settings modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const overlay       = document.getElementById('modal-overlay');
    const settBtn       = document.getElementById('settings-btn');
    const closeBtn      = document.getElementById('modal-close');
    const saveBtn       = document.getElementById('save-settings-btn');
    const sMarvin       = document.getElementById('s-marvin-token');
    const sMarvinFull   = document.getElementById('s-marvin-full-token');
    const sOpenai       = document.getElementById('s-openai-key');
    const firstRunEl    = document.getElementById('first-run-notice');

    function openSettings(isFirstRun = false) {
      sMarvin.value     = LS.marvinToken;
      sMarvinFull.value = LS.marvinFullToken;
      sOpenai.value     = LS.openaiKey;
      firstRunEl.style.display = isFirstRun ? '' : 'none';
      overlay.classList.add('open');
      if (!LS.marvinToken) sMarvin.focus();
    }
    function closeSettings() { overlay.classList.remove('open'); }

    settBtn.addEventListener('click', () => openSettings(false));
    closeBtn.addEventListener('click', closeSettings);
    overlay.addEventListener('click', e => { if (e.target === overlay) closeSettings(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeSettings(); });
    saveBtn.addEventListener('click', () => {
      LS.save(sMarvin.value.trim(), sMarvinFull.value.trim(), sOpenai.value.trim());
      closeSettings();
    });

    if (!LS.isConfigured) openSettings(true);

    // ‚îÄ‚îÄ Note text extractor (handles plain strings and Quill Delta JSON) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function extractNoteText(note) {
      if (!note) return '';
      if (typeof note === 'string') {
        try {
          const parsed = JSON.parse(note);
          if (parsed && Array.isArray(parsed.ops)) {
            return parsed.ops
              .filter(op => typeof op.insert === 'string')
              .map(op => op.insert)
              .join('').trim();
          }
        } catch (_) { /* plain string */ }
        return note.trim();
      }
      if (typeof note === 'object' && Array.isArray(note.ops)) {
        return note.ops
          .filter(op => typeof op.insert === 'string')
          .map(op => op.insert)
          .join('').trim();
      }
      return '';
    }

    // ‚îÄ‚îÄ Date query detection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function extractDateFromQuery(query) {
      const lower = query.toLowerCase();
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const fmt   = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      const add   = (d, n) => { const r = new Date(d); r.setDate(r.getDate() + n); return r; };

      if (/\btoday\b/.test(lower))     return fmt(today);
      if (/\btomorrow\b/.test(lower))  return fmt(add(today, 1));
      if (/\byesterday\b/.test(lower)) return fmt(add(today, -1));

      // getDay(): Sun=0, Mon=1 ‚Ä¶ Sat=6
      const days = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
      for (let i = 0; i < days.length; i++) {
        if (new RegExp(`\\bnext\\s+${days[i]}\\b`).test(lower)) {
          let delta = (i - today.getDay() + 7) % 7;
          delta = delta === 0 ? 7 : delta + 7;
          return fmt(add(today, delta));
        }
        if (new RegExp(`\\b${days[i]}\\b`).test(lower)) {
          const delta = (i - today.getDay() + 7) % 7;
          return fmt(add(today, delta));
        }
      }
      return null;
    }

    // ‚îÄ‚îÄ Keyword pre-filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const STOP_WORDS = new Set([
      'the','and','for','with','what','when','where','how','this','that','from',
      'are','was','were','been','have','has','will','you','your','not','can',
      'its','into','than','then','but','also','any','all','get','got','did',
      'does','about','which','there','their','they','would','use','using',
    ]);

    function keywordFilter(query, projects) {
      const words = query.toLowerCase()
        .replace(/[^a-z0-9 ]/g, ' ')
        .split(/\s+/)
        .filter(w => w.length > 2 && !STOP_WORDS.has(w));

      if (words.length === 0) return projects;

      const matches = projects.filter(p => {
        const haystack = ((p.title || '') + ' ' + extractNoteText(p.note)).toLowerCase();
        return words.some(w => haystack.includes(w));
      });

      return matches.length > 0 ? matches : projects; // fallback: return all
    }

    // ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const queryInput  = document.getElementById('query-input');
    const askBtn      = document.getElementById('ask-btn');
    const statusArea  = document.getElementById('status-area');
    const errorArea   = document.getElementById('error-area');
    const errorTitle  = document.getElementById('error-title');
    const errorDetail = document.getElementById('error-detail');
    const answerArea  = document.getElementById('answer-area');
    const answerText  = document.getElementById('answer-text');
    const metaQuery   = document.getElementById('meta-query');
    const metaProj    = document.getElementById('meta-projects');
    const metaCost    = document.getElementById('meta-cost');

    function resetUI() {
      statusArea.style.display = 'none';
      errorArea.style.display  = 'none';
      answerArea.style.display = 'none';
    }

    function showError(title, detail) {
      askBtn.disabled = false;
      statusArea.style.display = 'none';
      errorTitle.textContent  = title;
      errorDetail.textContent = detail;
      errorArea.style.display = 'block';
    }

    // ‚îÄ‚îÄ API helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function marvinGet(path, useFullToken = false) {
      const header = useFullToken
        ? { 'X-Full-Access-Token': LS.marvinFullToken }
        : { 'X-API-Token': LS.marvinToken };
      const res = await fetch(MARVIN_BASE + path, { headers: { ...header } });
      if (!res.ok) throw new Error(`Marvin API error ${res.status} for ${path}`);
      return res.json();
    }

    async function openaiChat(systemMsg, userMsg) {
      const res = await fetch(OPENAI_URL, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${LS.openaiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: MODEL,
          temperature: 0,
          messages: [
            { role: 'system', content: systemMsg },
            { role: 'user',   content: userMsg   },
          ],
        }),
      });
      if (res.status === 401) throw new Error('OpenAI API key is invalid or missing.');
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(`OpenAI error ${res.status}: ${err?.error?.message || 'unknown'}`);
      }
      const data = await res.json();
      return { content: data.choices[0].message.content.trim(), usage: data.usage };
    }

    // ‚îÄ‚îÄ Main search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function runSearch(query) {
      if (!LS.isConfigured) { openSettings(true); return; }

      resetUI();
      askBtn.disabled = true;
      statusArea.style.display = 'block';

      try {
        // Date queries: 2-level scan to find tasks at any nesting depth
        const targetDate = extractDateFromQuery(query);
        if (targetDate) {
          document.querySelector('#thinking-indicator span').textContent = `Scanning all projects for ${targetDate}‚Ä¶`;
          const allProjects = await marvinGet('/categories');
          const active = allProjects.filter(p => !p.done);
          // Also include inbox (tasks not assigned to any project)
          const sources = [...active, { _id: 'unassigned', title: 'Inbox' }];

          // Fetch children of every project in parallel (level 1)
          const childrenAll = await Promise.allSettled(
            sources.map(p => marvinGet(`/children?parentId=${p._id}`))
          );

          // Group tasks by project, keeping only those scheduled on targetDate
          const dateBlocks = [];
          const seenIds    = new Set();
          sources.forEach((proj, i) => {
            if (childrenAll[i].status !== 'fulfilled') return;
            const dayTasks = (childrenAll[i].value || [])
              .filter(t => t.db === 'Tasks' && t.day === targetDate);
            dayTasks.forEach(t => seenIds.add(t._id));
            if (dayTasks.length > 0) dateBlocks.push({ title: proj.title, tasks: dayTasks });
          });

          // Level 2: also scan children of items that have no day set
          // (container/sub-project tasks that house scheduled sub-tasks)
          const containers = [];
          sources.forEach((src, i) => {
            if (childrenAll[i].status !== 'fulfilled') return;
            (childrenAll[i].value || []).forEach(item => {
              if (!item.day) containers.push({ item, projTitle: src.title });
            });
          });

          if (containers.length > 0) {
            document.querySelector('#thinking-indicator span').textContent = 'Scanning nested tasks‚Ä¶';
            const level2Results = await Promise.allSettled(
              containers.map(({ item }) => marvinGet(`/children?parentId=${item._id}`))
            );
            containers.forEach(({ projTitle }, i) => {
              if (level2Results[i].status !== 'fulfilled') return;
              const newTasks = (level2Results[i].value || [])
                .filter(t => t.db === 'Tasks' && t.day === targetDate && !seenIds.has(t._id));
              if (newTasks.length === 0) return;
              newTasks.forEach(t => seenIds.add(t._id));
              const block = dateBlocks.find(b => b.title === projTitle);
              if (block) block.tasks.push(...newTasks);
              else dateBlocks.push({ title: projTitle, tasks: newTasks });
            });
          }

          const context = dateBlocks.length
            ? dateBlocks.map(b =>
                `== PROJECT: ${b.title} ==\n` +
                b.tasks.map(t => {
                  const status   = t.done ? 'DONE' : 'active';
                  const notePart = extractNoteText(t.note) ? `\n    Note: ${extractNoteText(t.note)}` : '';
                  return `  - [${status}] ${t.title}${notePart}`;
                }).join('\n')
              ).join('\n\n')
            : `(no tasks scheduled for ${targetDate})`;

          document.querySelector('#thinking-indicator span').textContent = 'Generating answer‚Ä¶';
          const { content: answer, usage: u2 } = await openaiChat(
            PROMPT_ANSWER_SYSTEM,
            `Question: ${query}\n\nTask manager data:\n${context}`
          );

          const totalTasks = dateBlocks.reduce((n, b) => n + b.tasks.length, 0);
          const costUsd = ((u2.prompt_tokens || 0) / 1e6) * 0.10 + ((u2.completion_tokens || 0) / 1e6) * 0.40;
          const costGbp = costUsd * 0.79;

          statusArea.style.display = 'none';
          answerText.textContent   = answer;
          metaQuery.textContent    = 'Query: ' + query;
          metaProj.textContent     = `Date: ${targetDate} ¬∑ ${totalTasks} task(s) across ${dateBlocks.length} project(s)`;
          metaCost.textContent     = `Cost: $${costUsd.toFixed(5)} (~¬£${costGbp.toFixed(5)})`;
          answerArea.style.display = 'block';
          askBtn.disabled          = false;
          return;
        }

        // Non-date queries: project-based search
        const allProjects = await marvinGet('/categories');
        console.debug('[Marvin] projects loaded:', allProjects.length);

        // Step 2: Identify relevant projects with OpenAI
        const candidates = keywordFilter(query, allProjects);
        console.debug('[Marvin] keyword candidates:', candidates.length, candidates.map(p => p.title));
        const roster = candidates.map(p => {
          const noteSnippet = extractNoteText(p.note) ? ` | Note: ${extractNoteText(p.note).slice(0, 80)}` : '';
          return `ID: ${p._id} | Title: ${p.title}${noteSnippet}`;
        }).join('\n');
        const userMsg1 = `Query: ${query}\n\nProjects:\n${roster}`;
        let relevantIds = [];
        // openaiChat throws on API errors (401, 429, etc.) ‚Äî let those propagate
        const { content: raw, usage: u1 } = await openaiChat(PROMPT_IDENTIFY_SYSTEM, userMsg1);
        console.debug('[Marvin] identify raw response:', raw);
        try {
          // Strip markdown code fences in case model wraps output
          const clean = raw.replace(/^```(?:json)?\s*|\s*```$/g, '').trim();
          const parsed = JSON.parse(clean);
          relevantIds = Array.isArray(parsed) ? parsed : [];
        } catch (_) {
          // JSON parse failed ‚Äî treat as no match
          relevantIds = [];
        }

        if (relevantIds.length === 0) {
          answerText.textContent =
            `No relevant projects were found for this query.\n` +
            `(Scanned ${candidates.length} candidate projects from ${allProjects.length} total)`;
          metaQuery.textContent  = 'Query: ' + query;
          metaProj.textContent   = '';
          allSteps.forEach(s => setStep(s, 'done'));
          answerArea.style.display = 'block';
          askBtn.disabled = false;
          return;
        }

        const projectMap = Object.fromEntries(candidates.map(p => [p._id, p]));
        const relevantProjects = relevantIds.map(id => projectMap[id]).filter(Boolean);

        // Step 3: Fetch doc + children for each project in parallel
        const contentBlocks = await Promise.all(relevantProjects.map(async (proj) => {
          const pid = proj._id;
          let note  = extractNoteText(proj.note);
          let tasks = [];

          const [docRes, childrenRes] = await Promise.allSettled([
            marvinGet(`/doc?id=${pid}`, true),
            marvinGet(`/children?parentId=${pid}`, false),
          ]);

          if (docRes.status === 'fulfilled')      note  = extractNoteText(docRes.value.note) || note;
          if (childrenRes.status === 'fulfilled') tasks = (childrenRes.value || []).filter(c => c.db === 'Tasks');

          return { title: proj.title, note, tasks };
        }));

        // Step 4: Generate answer
        const context = contentBlocks.map(b => {
          const taskLines = b.tasks.length
            ? b.tasks.map(t => {
                const status = t.done ? 'DONE' : 'active';
                const scheduledPart = t.day ? ` (scheduled: ${t.day})` : '';
                const notePart = extractNoteText(t.note) ? `\n    Note: ${extractNoteText(t.note)}` : '';
                return `  - [${status}] ${t.title}${scheduledPart}${notePart}`;
              }).join('\n')
            : '  (none)';
          return `== PROJECT: ${b.title} ==\nNotes:\n${b.note || '(none)'}\n\nTasks:\n${taskLines}`;
        }).join('\n\n');

        const userMsg2 = `Question: ${query}\n\nTask manager data:\n${context}`;
        const { content: answer, usage: u2 } = await openaiChat(PROMPT_ANSWER_SYSTEM, userMsg2);

        // Calculate cost (gpt-4.1-nano: $0.10/1M input, $0.40/1M output)
        const totalIn  = (u1.prompt_tokens     || 0) + (u2.prompt_tokens     || 0);
        const totalOut = (u1.completion_tokens || 0) + (u2.completion_tokens || 0);
        const costUsd  = (totalIn / 1e6) * 0.10 + (totalOut / 1e6) * 0.40;
        const costGbp  = costUsd * 0.79;

        // Display
        statusArea.style.display = 'none';
        answerText.textContent = answer;
        metaQuery.textContent  = 'Query: ' + query;
        const projNames = contentBlocks.map(b => b.title);
        metaProj.textContent = projNames.length ? 'Projects: ' + projNames.join(', ') : '';
        metaCost.textContent = `Cost: $${costUsd.toFixed(5)} (~¬£${costGbp.toFixed(5)})`;
        answerArea.style.display = 'block';
        askBtn.disabled = false;

      } catch (err) {
        const isCors = err instanceof TypeError && err.message.toLowerCase().includes('fetch');
        const title  = isCors ? 'Network / CORS error' : 'Search failed';
        const detail = isCors
          ? `Could not reach the API. If this is a CORS error, check the browser console for details. (${err.message})`
          : err.message;
        showError(title, detail);
      }
    }

    document.getElementById('search-form').addEventListener('submit', e => {
      e.preventDefault();
      const q = queryInput.value.trim();
      if (q) runSearch(q);
    });
  </script>
</body>
</html>
